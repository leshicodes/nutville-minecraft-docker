version: '3.8'

services:
  minecraft:
    image: itzg/minecraft-server:${MC_CONTAINER_VERS}
    container_name: ${MC_SERVER_HOSTNAME}
    hostname: ${MC_SERVER_HOSTNAME}
    ports:
      - "${MC_SERVER_PORT}:25565"
      # - 8888:8123
    volumes:
      - ./mc:/data
    env_file:
      - .env
      - .env.secrets
    restart: always
  minecraft-backup:
    image: itzg/mc-backup
    container_name: minecraft-backup-sidecar
    hostname: minecraft-backup-sidecar
    depends_on:
      minecraft:
        condition: service_healthy
    env_file:
      - .env
      - .env.secrets
    environment:
      RCON_HOST: ${MC_SERVER_HOSTNAME}
      PRE_BACKUP_SCRIPT: |
        echo "Beginning MC Server backup"
        rcon-cli --host minecraft say "Beginning MC Server backup ; You may experience lag."
    volumes:
      - ./mc:/data:ro
      - ./mc-backups:/backups